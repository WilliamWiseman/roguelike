<!DOCTYPE html>
<html>

<head>
</head>

<body>

    <style>
        body {
            background-color: white;
        }

        canvas {
            z-index: 1;
            position: absolute;
            left: 0;
            top: 0;
            width: 100vw;
        }

        .fog {
            z-index: 5;
        }
        .background {
            top:0;
            left:0;
            position:absolute;
            width:100%;
            z-index:2;
        }
        .entity {
            position:absolute;
            top:0;
            left:0;
            z-index:3;
        }
    </style>

    <canvas id="game" width="1024" height="448"></canvas>
    <img class="background">
    <canvas id="fog" width="1024" height="448" class="fog"></canvas>

    <script>
        let frames = 0;
        const pixelSize = window.innerWidth / 1024;
        const canvas = document.getElementById("game");
        canvas.style.height = `${pixelSize * 448}px`;
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const fogCanvas = document.getElementById("fog");
        fogCanvas.style.height = `${pixelSize * 448}px`;
        const fogctx = fogCanvas.getContext("2d");
        
        let levels = ["https://raw.githubusercontent.com/WilliamWiseman/roguelike/main/levels/1.json"];

        fogctx.fillStyle = "rgba(0, 0, 0, 0.95)";
        fogctx.fillRect(0, 0, 1024, 448);

        let fps = 120;
        let canMove = true;

        function hitbox(x, y, width, height) {
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            return this;
        }

        function creature(name, x, y, height, width, hp, src) { //this is a creature with a sprite and bounding box
            this.name = name;
            this.maxHp = hp;
            this.hp = hp;
            this.x = x;
            this.y = y;
            this.height = height;
            this.width = width;
            this.momX = 0;
            this.momY = 0;
            this.index = creatureArr.length;
            this.img = false;

            creature.prototype.appear = function () { //creates the physical DOM object and PUTS IT IN ITS PLACE
                this.img = document.createElement('img');
                this.img.class = "entity";
                this.img.style.top = `${this.y * tileSize}px`;
                this.img.style.left = `${this.x * tileSize}px`;
                this.img.style.width = `${this.width * tileSize}px`;
                this.img.style.height = `${this.height * tileSize}px`;
            }

            creature.prototype.move = function () {

                if(!this.img){
                    this.appear();
                }

                this.x += this.momX;
                if (
                    getColor(this.x, this.y) !== 0 ||
                    getColor(this.x + this.width -1, this.y) !== 0 ||
                    getColor(this.x, this.y + this.height -1) !== 0 ||
                    getColor(this.x + this.width -1, this.y + this.height -1) !== 0 ||
                    this.x < 0 ||
                    this.x + this.width > canvas.width
                ) {
                    this.x -= this.momX;
                }
                this.y += this.momY;
                if (
                    getColor(this.x, this.y) !== 0 ||
                    getColor(this.x + this.width -1, this.y) !== 0 ||
                    getColor(this.x, this.y + this.height -1) !== 0 ||
                    getColor(this.x + this.width -1, this.y + this.height -1) !== 0 ||
                    this.y < 0 ||
                    this.y + this.height > canvas.height
                ) {
                    this.y -= this.momY;
                }

                this.img.style.top = `${this.y * tileSize}px`;
                this.img.style.left = `${this.x * tileSize}px`;

            };

            creature.prototype.center = function () {
                let object = {
                    x: this.x + (this.width / 2),
                    y: this.y + (this.height / 2)
                }
                return object;
            }

        }
        let creatureArr = [];
        let wallArr = [];

        let PLAYER = new creature("KNIGHT", 0, 0, 64, 64, 100, "/images/chest.gif");
        creatureArr.push(PLAYER);




        document.addEventListener("keydown", function (event) {
            event.preventDefault();
            let key = event.key;
            key = key.toLowerCase();
            switch (key) {
                case "a":
                    creatureArr[0].momX = -1;
                    break;
                case "d":
                    creatureArr[0].momX = 1;
                    break;
                case "w":
                    creatureArr[0].momY = -1;
                    break;
                case "s":
                    creatureArr[0].momY = 1;
                    break;
                case "f":
                    getFrameRate();
            }
        });

        document.addEventListener("keyup", function (event) {
            event.preventDefault();
            let key = event.key;
            key = key.toLowerCase();
            switch (key) {
                case "a":
                    if (creatureArr[0].momX < 0) {
                        creatureArr[0].momX = 0;
                    }
                    break;
                case "d":
                    if (creatureArr[0].momX > 0) {
                        creatureArr[0].momX = 0;
                    }
                    break;
                case "w":
                    if (creatureArr[0].momY < 0) {
                        creatureArr[0].momY = 0;
                    }
                    break;
                case "s":
                    if (creatureArr[0].momY > 0) {
                        creatureArr[0].momY = 0;
                    }
                    break;
            }
        });

        function gameLoop() {
            draw();
            frames++;
            requestAnimationFrame(gameLoop);
        }
        requestAnimationFrame(gameLoop);

        function collision(a, b) {
            return !(
                ((a.y + a.height) < (b.y)) || //checks if a is higher than b's y
                (a.y > (b.y + b.height)) || // checks if b is lower  than a's y
                ((a.x + a.width) < b.x) || // checks if a is more left than b 
                (a.x > (b.x + b.width))// checks if a is more right than b
            );
        };

        function getColor(x, y) {
            const imgdata = ctx.getImageData(x, y, 1, 1);
            const red = imgdata.data[0];
            return red;
        };

        let radius = 100;
        let change = 0.05;
        let collisionMap = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0]];
        const tileSize = 32;

        function draw() {
            fogctx.fillStyle = 'black';
            fogctx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            //Show light
            radius += change;
            if (radius > 105 || radius < 95) {
                change = -change;
            }
            light(creatureArr[0].center(), radius);
            // Draw collision Map
            for (let y = 0; y < collisionMap.length; y++) {
                for (let x = 0; x < collisionMap[y].length; x++) {
                    if (collisionMap[y][x]) {
                        ctx.fillStyle = 'red';
                        ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                    }
                }
            }

            //move characters. They can only move (whatever fps is set to) times a second in order to keep the speed constant.
            if (canMove) {
                for (let i = 0; i < creatureArr.length; i++) {
                    creatureArr[i].move();
                }
                canMove = false;
                setTimeout(() => {
                    canMove = true;
                }, 1000 / fps);
            }

        };

        function idk() {
            let average = Math.floor(frames / 5);
            alert(`You average fps was:${average} over the last 5 seconds.`);
        }
        function getFrameRate() {
            frames = 0;
            setTimeout(idk, 5000);
        }

        function light(position, radius) {
            fogctx.globalCompositeOperation = "source-over";
            fogctx.fillStyle = "rgba(0, 0, 0, 0.8)";
            fogctx.beginPath();
            fogctx.arc(position.x, position.y, radius, 0, 2 * Math.PI);
            fogctx.fill();

            fogctx.globalCompositeOperation = "destination-out";
            fogctx.fillStyle = "rgba(0, 0, 0, 0.3)";
            fogctx.beginPath();
            fogctx.arc(position.x, position.y, radius * 0.9, 0, 2 * Math.PI);
            fogctx.fill();

            // "Cut out" the center for the light
            fogctx.beginPath();
            fogctx.arc(position.x, position.y, radius * 0.8, 0, 2 * Math.PI);
            fogctx.fillStyle = "rgba(0, 0, 0, 1)";
            fogctx.fill();

            // Reset composite mode for next frame
            fogctx.globalCompositeOperation = "source-over";
        }

        function loadLevel(){
        //pick a random level
        let key = Math.floor(Math.random() * levels.length);
        let level = loadJSON(levels[key]);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        creatureArr[0].x = level.start.x;
        creatureArr[0].y = level.start.y + tileSize;

        for (let y = 0; y < level.clsnMap.length; y++) {
                for (let x = 0; x < level.clsnMap[y].length; x++) {
                    if (level.clsnMap[y][x]) {
                        ctx.fillStyle = 'red';
                        ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                    }
                }
            }

        }

        async function loadJSON(path) {
  try {
    const response = await fetch(path);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching JSON:', error);
  }
}
loadLevel();
    </script>
</body>

</html>