<!DOCTYPE html>

<html>

<body>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: lightblue;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        .gameArea {
            position: relative;
            width: 100%;
            height: calc(100vw / 16 * 7);
            top: 0;
            left: 0;
            padding: 0px;
            margin: 0px;
            overflow-x: hidden;
            overflow-y: scroll;
            background-image: url("images/map1.gif");
            background-repeat: no-repeat;
            background-size: cover;

        }

        .tiles {
            z-index: 2;
            height: 3.125vw;
            width: 3.125vw;
            position: absolute;
            background-color: transparent;
        }

        .tiles::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0;
        }

        .tiles:hover::after {
            opacity: 0.2;
        }
    </style>
    <div id="add" class="gameArea"></div>
    <script>
        const pixelSize = window.innerWidth / 1024;
        let clicking = false;

        let levelData = {
            start:{
                x:0,
                y:0
            },
            clsnMap:[],
            door:{
                x:0,
                y:0
            },
            chests:[],
            src:"images/map1.gif"
        }

        let mousePos = {
            x:0,
            y:0
        }
        let grid = [ //this is the collision map
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];
        function createWorld() {
            for (let z = 0; z < 32; z++) {
                let newYarr = [];
                for (let i = 0; i < 14; i++) {
                    let tile = document.createElement('div');
                    tile.classList = "tiles";
                    tile.style.top = `${3.125 * i}vw`;
                    tile.style.left = `${3.125 * z}vw`;
                    tile.onmouseover = function () {
                        if(clicking){
                        if(grid[i][z]){
                            grid[i][z] = 0;
                            tile.style.opacity = "0";
                            tile.style.backgroundColor = "black";
                        }else{
                            grid[i][z] = 1;
                            tile.style.opacity = "0.2";
                            tile.style.backgroundColor = "red";
                        }
                    }
                    mousePos.x = z;
                    mousePos.y = i;
                    };
                    tile.onmousedown = function () {
                        if(grid[i][z]){
                            grid[i][z] = 0;
                            tile.style.opacity = "0";
                            tile.style.backgroundColor = "black";
                        }else{
                            grid[i][z] = 1;
                            tile.style.opacity = "0.2";
                            tile.style.backgroundColor = "red";
                        }
                    };
                    this.newObj = {};
                    this.newObj.block = tile;
                    document.getElementById('add').appendChild(tile); // append directly
                }
            }
        }
        createWorld();

        document.addEventListener("mousedown", function (event) {
            clicking = true;
        });
        document.addEventListener("mouseup", function (event) {
            clicking = false;
        });

        function chest(x, y, chance){
            this.x = x;
            this.y = y;
            this.chance = chance;
        }

        document.addEventListener("keyup", function (event) {
            event.preventDefault();
            let key = event.key;
            key = key.toLowerCase();
            switch (key) {
                case " ":
                        placeChest();
                    break;
                    case "q":
                        placeSpawn();
                    break;
                    case "e":
                        placeExit();
                    break;
                    case "l":
                        save();
                    break;
            }
        });

        function placeChest(){
            let CHEST = document.createElement('img');
            CHEST.src = "images/chest.gif";
            CHEST.style = `position:absolute;width:${64 * pixelSize}px;height:${64 * pixelSize}px`;
            CHEST.style.top = `${mousePos.y * 32 * pixelSize}px`;
            CHEST.style.left = `${mousePos.x * 32 * pixelSize}px`;
            document.body.appendChild(CHEST);
            let chance = prompt('What percentage chance should the chest spawn?');
            levelData.chests.push(new chest(mousePos.x * 32, mousePos.y * 32, chance * 1));
            console.log(levelData);
        }
        let spawn;
        let exit;
        function placeSpawn(){
            if(spawn === undefined){
            spawn = document.createElement('img');
            spawn.src = "images/door.gif";
            spawn.style = `position:absolute;width:${64 * pixelSize}px;height:${64 * pixelSize}px`;
            }
            spawn.style.top = `${mousePos.y * 32 * pixelSize}px`;
            spawn.style.left = `${mousePos.x * 32 * pixelSize}px`;
            document.body.appendChild(spawn);
            levelData.start = {
                x:mousePos.x * 32,
                y:(mousePos.y + 1) * 32
                };
            console.log(levelData);
        }

        function placeExit(){
            if(exit === undefined){
            exit = document.createElement('img');
            exit.src = "images/door.gif";
            exit.style = `position:absolute;width:${64 * pixelSize}px;height:${64 * pixelSize}px`;
            }
            exit.style.top = `${mousePos.y * 32 * pixelSize}px`;
            exit.style.left = `${mousePos.x * 32 * pixelSize}px`;
            document.body.appendChild(exit);
            levelData.door = {
                x:mousePos.x * 32,
                y:(mousePos.y + 1) * 32
                };
            console.log(levelData); 
        }

        async function save() {
    try {
        handle = await window.showSaveFilePicker({
            suggestedName: 'save.json',
            types: [{
                description: 'JSON Files',
                accept: { 'application/json': ['.json'] },
            }],
        });
        levelData.clsnMap = grid;
        const jsonString = JSON.stringify(levelData);
        const writableStream = await handle.createWritable();
        await writableStream.write(jsonString);
        await writableStream.close();

    } catch (error) {
        console.error('Error:', error);
        alert('Could not save.');
    }
}

    </script>

</body>

   </html>